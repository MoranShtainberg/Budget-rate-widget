<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
  
  
    <style>
      #forward-value-id{
        color: blue;
      }

      #limitation-of-liability{
        font-size:x-small;
      }
    </style>
  </head>
  
  <body>

    <div class="container">
      <h1>Calc fellow's Budget rate widget</h1>
       <!----------------------------------------- row 1: Currency Pair -->
      <div class="row p-2">
        <div class="col">
          <label>Currency Pair</label>

          <select class="form-select" aria-label="Default select example" id="currency-pair-select-id">
            <!-- <option selected>Open this select menu</option>
            <option value="1">One</option>
            <option value="2">Two</option>
            <option value="3">Three</option> -->
            <option selected>EURUSD</option>
          </select>
        </div>
        
        <div class="col">
         
        </div>  
      </div> <!-----------------------------------------END: row 1 -->

      <!----------------------------------------- row 2: Exposure direction  radio -->
      <div class="row p-2">
        <label>Exposure direction</label>

          <div class="form-check ps-5">
            <input class="form-check-input" type="radio" name="flexRadioDefault" id="direction-up-id">
            <label class="form-check-label" for="direction-up-id">
              Up
            </label>
          </div>

          <div class="form-check ps-5">
            <input class="form-check-input" type="radio" name="flexRadioDefault" id="direction-down-id">
            <label class="form-check-label" for="direction-down-id">
              Down
            </label>
          </div>     

        <span class="ps-5 d-none" id="span-apreciation">
            Appreciation of the <span id="span-major-apreciation">EUR</span> against the <span id="span-minor-apreciation">USD</span>
        </span>

        <span class="ps-5 d-none" id="span-depreciation">
            Depreciation of the <span id="span-major-depreciation">EUR</span> against the <span id="span-minor-depreciation">USD</span>
        </span>

        <div class="col">
         
        </div> 

      </div><!-------------------------------------------END: row 2 -->
      <!----------------------------------------- row 3: Exposure period -->
      <div class="row p-2">
        <div class="col">
          <label>Exposure period</label>

          <select class="form-select" aria-label="Default select example" id="exposure-period-id">
            <!-- <option selected>Open this select menu</option> -->
            <option value="2 Month">2 Month</option>
            <option value="6 Month">6 Month</option>
            <option selected value="1 Year">1 Year</option>
            <option value="2 Year">2 Year</option>
          </select>
        </div>
        
        <div class="col">
         
        </div> 
      </div><!-------------------------------------------END: row 3 -->

      <!------------------------------------------- row 4: forward rate -->
      <div class="row p-2">
        <div class="col">
          <span>The current spot is: </span>
          <span id="current-spot-id"></span>
          <br>

          <div class="input-group mb-3">
            <span class="input-group-text" id="basic-addon3">Forward rate for the mid-exposure period:</span>
            <input type="number" class="form-control" id="forward-value-id" aria-describedby="basic-addon3" disabled></input>
            
          </div>

          <!-- <span>The current spot is: </span>
          <span id="current-spot-id"></span>
          <br>
          <span>The forward rate for the mid-exposure period is:</span>
          <span id="forward-value-id"></span>           -->

        </div>

         <div class="col">
          
        </div>
      </div><!--------------------------------------------END: row 4 -->

      <!------------------------------------------- row 5: hedged rate -->
      <div class="row p-2">
          <div class="col">
            <label>Enter the current hedged rate for the period (weighted average)</label>

            <input type="number" step="0.0001" min="0" max="10" id="hedged-rate-id">
          </div>
          
          <div class="col">
          
          </div> 
      </div><!-------------------------------------------END: row 5 -->
      <!-- ------------------------------------------------row 6:  hedged percentage -->
      <div class="row p-2">
          <div class="col">
            <label>Choose the current hedged percentage for the period</label>

            <select class="form-select" aria-label="Default select example" id="hedged-percentage-id">
              <!-- <option selected>Open this select menu</option> -->
              <!-- <option>1%</option>
              <option>2%</option>
              <option>3%</option>
              <option>4%</option> -->
            </select>
          </div>
          
          <div class="col">
          
          </div> 
      </div><!-------------------------------------------END row 6 -->

      <!-- ----------------------------------------------row 7: Margin of safety -->
      <div class="row p-2">
          <div class="col">
            <label>Margin of safety</label>

            <select class="form-select" aria-label="Default select example" id="margin-of-safety-id">
              <!-- <option selected>Open this select menu</option> -->
              <option selected value="0">0%</option>
              <!-- <option>0.5%</option> -->
              <!-- <option>1.0%</option> -->
              <!-- <option>1.5%</option> -->
            </select>
          </div>
          
          <div class="col">          
          </div> 
      </div><!-------------------------------------------END row 7 -->

        <div class="row p-2">
          <div class="col">
            <div id="liveAlertPlaceholder"></div> 

            <div class="d-grid gap-2">
              <button class="btn btn-primary" type="button" id="calculate-btn-id">Calculate the budget rate</button>              
            </div>
          </div>

          <div class="col">          
          </div>
        </div>

      <!-- ----------------------------------------------row 8 Budget rate-->
      <div class="row p-2">
          <div class="col">
            <label class="fs-3">Budget rate: </label>

            <input type="number" step="0.0001" min="0" max="10" disabled class="fs-3" id="budget-rate-id">

            
          </div>
          
          <div class="col">
          
          </div> 
      </div><!------------------------------------------- row 8: Limitation of Liability-->
     
      <div class="row pt-4">
          <div class="col">
             <hr>
            <!-- <div class="form-floating">
              <textarea class="form-control" placeholder="Leave a comment here" id="floatingTextarea" disabled></textarea>
              <label for="floatingTextarea">Comments</label>
            </div> -->

            <h6>Limitation of Liability</h6>

            <p id="limitation-of-liability">
              IN NO EVENT WILL THE OWNER OF THE WEBSITE AND / OR THE CREATOR OF THE CALCULATORS OR ITS THIRD PARTY PROVIDERS BE LIABLE FOR ANY DAMAGES, INCLUDING WITHOUT LIMITATION DIRECT OR INDIRECT, SPECIAL, INCIDENTAL, PUNITIVE, OR CONSEQUENTIAL DAMAGES, LOSSES OR EXPENSES ARISING OUT OF OR RELATING TO YOUR USE OF THE WEBSITE, ANY FAILURE OF PERFORMANCE, ERROR, OMISSION, INTERRUPTION, DEFECT, DELAY IN OPERATION OR TRANSMISSION, COMPUTER VIRUS, LINE OR SYSTEM FAILURE, UNAUTHORIZED INTERCEPTION OF INFORMATION, OR OTHER SECURITY THREATS RELATING TO THE WEBSITE, EVEN IF THE OWNER OF THE WEBSITE AND / OR THE CREATOR OF THE CALCULATORS OR THEIR AGENTS OR ADVISORS ARE ADVISED OF THE POSSIBILITY OF SUCH DAMAGES, LOSSES OR EXPENSES. PAST PERFORMANCE IS NO GUARANTEE OF FUTURE RESULTS.
            </p>
          </div>
          
          <div class="col">
          
          </div> 
      </div><!------------------------------------------- row 9 -->

    </div> <!-- container -->
    

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous">
    </script>

    <script>
        function run_getDropDownArray(){
          // console.log("eeeeeeeeeeeeeeeee");        
          google.script.run.withSuccessHandler(afterDropDownArrayReturned).getDropDownArray();
        };

        function run_getForwardTable(){
          var currency_Pair = document.getElementById("currency-pair-select-id").value;
          google.script.run.withSuccessHandler(afterForwardTableReturned).getForwardTable(currency_Pair);
        };

        function afterForwardTableReturned(forwardRow){

          var exposurePeriodText = document.getElementById("exposure-period-id").value;
          console.log("exposurePeriodText: "+exposurePeriodText);

          var exposurePeriodIndex;
          if(exposurePeriodText == "1 Year"){
            exposurePeriodIndex = 5;
          } else if(exposurePeriodText == "2 Month"){
            exposurePeriodIndex = 3;
          } else if(exposurePeriodText == "6 Month"){
            exposurePeriodIndex = 4;
          } else if(exposurePeriodText == "2 Year"){
            exposurePeriodIndex = 6;
          }

          console.log("exposurePeriodIndex: "+exposurePeriodIndex);
          console.log("forwardRow");
          console.log(forwardRow); 
          console.log(forwardRow[0][exposurePeriodIndex]);
          
          document.getElementById("current-spot-id").textContent = forwardRow[0][1].toFixed(4);
          // document.getElementById("forward-value-id").textContent = forwardRow[0][exposurePeriodIndex].toFixed(4);
          document.getElementById("forward-value-id").value = forwardRow[0][exposurePeriodIndex].toFixed(4);

        };

        function afterDropDownArrayReturned(objReturned) {
          console.log("objReturned");
          console.log(objReturned);
          // console.log("objReturned.currencyPairs");
          // console.log(objReturned.currencyPairs);

          // ---------------------------------------------------
          var item_currencyPair = document.getElementById("currency-pair-select-id");    

          objReturned.currencyPairs.forEach(function(r){
            var option = document.createElement("option");
            option.textContent = r[0];
            item_currencyPair.appendChild(option);
          });
          // ---------------------------------------------------
          var hedgedPercentage =  document.getElementById("hedged-percentage-id");  
          
          objReturned.current_hedged_percentage.forEach(function(r){
            var option = document.createElement("option");
            option.textContent = (r[0]*100).toFixed(1) +"%";
            option.setAttribute("value",r[0])
            hedgedPercentage.appendChild(option);
          });
          //----------------------------------------------------
          
          var marginOfSafety = document.getElementById("margin-of-safety-id")

          objReturned.margin_of_safety.forEach(function(r){
            var option = document.createElement("option");
            option.textContent = (r[0]*100).toFixed(1) +"%";
            option.setAttribute("value",r[0])
            marginOfSafety.appendChild(option);
          });
          //-------------------------------------------------------
          run_getForwardTable();
        };//afterDropDownArrayReturned
        //=======================================================================

        var hedgingDirectionValue;
        function hendelDirectionUpChange(){
          var hedgingDirection = document.getElementById("direction-up-id");
          hedgingDirectionValue = hedgingDirection.checked? "Up" : "Down";

          // console.log("hedgingDirectionValue: "+hedgingDirectionValue);
          document.getElementById("span-depreciation").classList.add("d-none");
          document.getElementById("span-apreciation").classList.remove("d-none");
          updateSpanUp();
        };

        function updateSpanUp(){
          var currency_Pair = document.getElementById("currency-pair-select-id").value;
          var major_ccy = currency_Pair.substring(0, 3);
          var minor_ccy =  currency_Pair.substring(3, 6);
          document.getElementById("span-major-apreciation").textContent = major_ccy;
          document.getElementById("span-minor-apreciation").textContent = minor_ccy;
        }

        function hendelDirectionDownChange(){
          var hedgingDirection = document.getElementById("direction-down-id");
          hedgingDirectionValue = hedgingDirection.checked? "Down" : "Up";

          console.log("hedgingDirectionValue: "+hedgingDirectionValue);
          document.getElementById("span-apreciation").classList.add("d-none");
          document.getElementById("span-depreciation").classList.remove("d-none");
          updateSpanDown()
        };

        function updateSpanDown(){
          var currency_Pair = document.getElementById("currency-pair-select-id").value;
          var major_ccy = currency_Pair.substring(0, 3);
          var minor_ccy =  currency_Pair.substring(3, 6);          
          document.getElementById("span-major-depreciation").textContent = major_ccy;
          document.getElementById("span-minor-depreciation").textContent = minor_ccy;
        }

        function hedelCurrencyPairChange(){
          document.getElementById("span-apreciation").classList.add("d-none");
          document.getElementById("span-depreciation").classList.add("d-none");
          document.getElementById("direction-up-id").checked = false;
          document.getElementById("direction-down-id").checked = false;

          document.getElementById("budget-rate-id").value = "";
          document.getElementById("margin-of-safety-id").value = 0;          
          document.getElementById("hedged-percentage-id").value = 0;
          document.getElementById("hedged-rate-id").value = "";
          hedgingDirectionValue = "";

          run_getForwardTable();
        }

        var alertPlaceholder;

        function budgetRateCaculation(){
          //hedgingDirectionValue

          var plusOrMinus;
          if(hedgingDirectionValue == "Up"){
            plusOrMinus = 1;
          } else if(hedgingDirectionValue == "Down"){
            plusOrMinus = -1;
          } else{
            alertPlaceholder = document.getElementById('liveAlertPlaceholder');
            return alert('Please select "Exposure direction"!', 'danger')
          }       

          var forwardRateInput = document.getElementById("forward-value-id").value;
          var chosenMarginOfSafty = document.getElementById("margin-of-safety-id").value;          
          var hedgedPercentage = document.getElementById("hedged-percentage-id").value;
          var hedgedRate = document.getElementById("hedged-rate-id").value;

          if(hedgedPercentage>0 && hedgedRate == ""){
            alertPlaceholder = document.getElementById('liveAlertPlaceholder');
            return alert('Please enter "hedged rate"!', 'danger');         
          }

          console.log("forwardRateInput: "+forwardRateInput);
          console.log("chosenMarginOfSafty: "+chosenMarginOfSafty);
          console.log("hedgingDirectionValue: "+hedgingDirectionValue);
          console.log("hedgedPercentage: "+hedgedPercentage);
          console.log("hedgedRate: "+hedgedRate);
          console.log("plusOrMinus: "+plusOrMinus);

          var budgetRateHalf_1 = (forwardRateInput*(1+chosenMarginOfSafty*plusOrMinus)*(1-hedgedPercentage));
          var budgetRateHalf_2 = hedgedRate * hedgedPercentage;
          var budgetRate = budgetRateHalf_1 + budgetRateHalf_2;
          document.getElementById("budget-rate-id").value = budgetRate.toFixed(4);

          console.log("budgetRateHalf_1: "+budgetRateHalf_1);
          console.log("budgetRateHalf_2: "+budgetRateHalf_2);
          console.log("budgetRate: "+budgetRate);

        }

        function alert(message, type) {
          var wrapper = document.createElement('div')
          wrapper.innerHTML = '<div class="alert alert-' + type + ' alert-dismissible" role="alert">' + message + '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>'

          alertPlaceholder.append(wrapper)
        }

        
        document.getElementById("direction-up-id").addEventListener("change",hendelDirectionUpChange);
        document.getElementById("direction-down-id").addEventListener("change",hendelDirectionDownChange);
        document.getElementById("currency-pair-select-id").addEventListener("change",hedelCurrencyPairChange);
        document.getElementById("exposure-period-id").addEventListener("change",run_getForwardTable);
        document.getElementById("calculate-btn-id").addEventListener("click",budgetRateCaculation);

        document.addEventListener('DOMContentLoaded',run_getDropDownArray);
    </script>
  </body>
</html>
